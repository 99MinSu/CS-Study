# 멀티 프로세스와 멀티 스레드

멀티 프로세스와 멀티 스레드는 하나의 응용 프로그램에 대한 처리방식 이라고 보면 된다.

- 이름으로 유추할 수 있듯이 멀티 프로세스와 멀티 스레드는 여러개의 프로세스, 스레드가 동작하는 것을 일 컫는다.

![1](https://github.com/user-attachments/assets/0ce24977-4c12-40dd-9f7e-3397705a9f0d)

- 다중으로 돌아감으로써 성능 향상 등 여러가지 효과를 얻을 수 있지만 또한 이로 인해 발생되는 문제점도 발생하게 된다

# 멀티 프로세스(**Multi Process)**

하나의 응용 프로그램을 두개 이상의 프로세스로 구성하여 각 프로세스가 하나의 작업을 목표로로 처리하도록 하는 것이다.

- 보통 하나의 프로세스가 메모리에 생서어되지만, 부가적인 기능을 위해 여러개의 프로세스를 생성한다.

멀티 프로세스 내부를 보면, 하나의 부모 프로세스가 여러 개의 자식 프로세스를 생성함으로서 다중 프로세스를 구성하는 구조이다. 

![1](https://github.com/user-attachments/assets/7db42088-5bdd-4972-bc98-4b3cd1481584)

한 프로세스는 실행되는 도중 프로세스 생성 시스템 콜을 통해 새로운 프로세스들을 생성할 수 있는데, 다른 프로세스를 생성하는 프로세스를 부모 프로세스(Parent Process)라 하고, 다른 프로세스에 의해 생성된 프로세스를 자식 프로세스(Child Process)라 한다.

- 부모 프로세스와 자식 프로세스는 각각 고유한 PID(Process ID)를 가지고 있다.
- 부모 프로세스는 자식 프로세스의 PID를 알고 있으며, 이를 통해 자식 프로세스를 제어할 수 있다.
- 자식 프로세스는 부모 프로세스의 PID와 PPID(Parent Process ID)를 알고 있어, 이를 통해 부모 프로세스와의 통신이 가능하다.

다만, 통신이 가능할 뿐이지, 부모 프로세스와 자식 프로세스는 엄연히 서로 다른 프로세스로 독립적으로 실행되며, 독립적인 메모리 공간을 가지고 있어 서로 다른 작업을 수행한다. 

![515](https://github.com/user-attachments/assets/233cb81b-6ef6-4e59-9665-003be07789a1)

대표적인 예로 웹 브라우저의 상단 탭(Tab) 이나 새 창을 들 수 있다. 각 브라우저 탭은 같은 브라우저 프로그램 실행이지만, 각기 다른 사이트 실행을 행하기 때문이다.

## 장점

### **프로그램 안전성**

멀티 프로세스는 각 프로세스가 독립적인 메모리 공간을 가지므로, 한 프로세스가 비정상적으로 종료되어도 다른 프로세스에 영향을 주지 않아 안정성이 높다.

- 프로그램 전체의 안전성을 확보할 수 있다는 장점이 있다.

### **프로그램 병렬성**

멀티 프로세스와 여러개의 CPU 코어를 활용하여 둘의 시너지를 합쳐, 다중 CPU 시스템에서 각 프로세스를 병렬적으로 실행하여 성능을 향상 시킬 수 있다. 

![123dd](https://github.com/user-attachments/assets/559afec7-b968-44a2-96f2-d141d1e58cc5)

- 예를 들어 이미지 처리나 비디오 인코딩과 같은 작업을 여러 개의 코어나 CPU에 분산시켜 빠르게 처리할 수 있다.
- 멀티 프로세스 만의 장점이라기 보단, 멀티 프로세스와 멀티 스레드 둘의 장점이다.
- CPU를 많이 사용하는 작업이라면 멀티 프로세스가 더 효율적일 수 있다.( 각 프로세스가 독립적으로 실행되어 여러 코어를 효과적으로 사용할 수다.)
- 여러 개의 프로세스가 처리되어야 할 때 동일한 데이터를 사용하고, 이러한 데이터를 하나의 디스크에 두고 모든 프로세서(CPU)가 이를 공유하면 비용적으로 저렴하다.

독립적인 프로세스가 서로 영향을 미치지 않으며 병렬로 실행될 수 있다는 말은 각 프로세스가 독립적이므로, 새로운 기능이나 모듈을 추가하거나 수정할 때 다른 프로세스에 영향을 주지 않는다는 것을 의미한다. 

- 이를 통해 시스템을 확장하거나 변경하는 것이 용이해진다.

## 단점

### **Context Switching Overhead**

컨텍스트 스위칭(context switching) 과정에서 성능 저하가 올 수 있다.

![1](https://github.com/user-attachments/assets/071c97ca-ac63-4f61-8281-e8e9bdf6d025)

 특히나 프로세스를 컨텍스트 스위칭 하면, CPU는 다음 프로세스의 정보를 불러오기 위해 메모리를 검색하고, CPU 캐시 메모리를 초기화하며, 프로세스 상태를 저장하고, 불러올 데이터를 준비해야 하기 때문에, 이로 인한 빈번한 Context Switching 작업으로 인해 비용 오버헤드가 발생할 수 있게 된다.

- 스레드를 컨텍스트 스위칭하면 프로세스 스위칭 보다 가벼워 훨씬 빠르고 좋다

### **자원 공유 비효율성**

멀티 프로세스는 각 프로세스가 독립적인 메모리 공간을 가지므로, 결과적으로 메모리 사용량이 증가하게 된다.

- 만일 각 프로세스간에 자원 공유가 필요할 경우 프로세스 사이의 어렵고 복잡한 통신 기법인 IPC(Inter-Process Commnuication)을 사용하여야 한다.

---

# 멀티 스레드(**Multi Thread)**

하나의 프로세스에 여러 스레드로 자원을 공유하며 작업을 나누어 수행하는 것이다.

- 따라서 하나의 프로그램에서 두가지 이상의 동작을 동시에 처리하도록 하는 행위가 가능해진다.

![1](https://github.com/user-attachments/assets/47933c28-b0e3-41ff-b389-eed53c976199)

멀티 프로세스가 웹 브라우저에서의 여러 탭이라면 멀티 스레드는 웹 브라우저의 단일 탭에서 브라우저 이벤트 루프, 네트워크 처리, I/O 및 기타 작업을 관리하고 처리하는데 사용된다고 보면된다.

- 웹 서버는 대표적인 멀티 스레드 응용 프로그램이다.
- 사용자가 서버 데이터베이스에 자료를 요청하는 동안 브라우저의 다른 기능을 이용할 수 있는 이유도 바로 멀티 스레드 기능 덕분인 것이다.
- 하나의 스레드가 지연되더라도, 다른 스레드는 작업을 지속할 수 있게 된다.

## 장점

### **스레드는 프로세스보다 가벼움**

스레드는 프로세스 내에서 생성되기 때문에 스레드의 실행 환경을 설정하는 작업이 매우 간단하여 생성 및 종료가 빠르다. 

- 스레드는 프로세스와 달리 대부분의 자원을 공유하므로, 메모리 사용량이 상대적으로 적다.
- 스레드를 생성하고 제거할 때, 프로세스 내부의 자원만을 관리하면 되기 때문에 프로세스 생성, 제거 보다 훨씬 빠르다.

### **자원의 효율성**

멀티 스레드는 하나의 프로세스 내에서 여러 개의 스레드를 생성되기 때문에, heap 영역과 같은 공유 메모리에 대해 스레드 간에 자원을 공유가 가능하다. 

![12](https://github.com/user-attachments/assets/bc30384b-a4e3-4f9e-b8f4-c4faf31f5400)

- 이를 통해, 프로세스 간 통신 (IPC)을 사용하지 않고도 데이터를 공유할 수 있기 때문에, 자원의 효율적인 활용이 가능해 시스템 자원 소모가 줄어든다.

### **Context Switching 비용 감소**

스레드에도 컨텍스트 스위칭 오버헤드가 존재한다. 하지만 상대적으로 프로세스 컨텍스트 스위칭 오버헤드보다 훨씬 낮아 비용이 낮다는 장점이 있다.

- 프로세스 컨텍스트 스위칭 비용은 스위칭할 때마다 CPU 캐시에 있는 내용을 모두 초기화하고, 새로운 프로세스 정보를 CPU 캐시에 적재해야 하므로 높은 비용이 든다.
- 반면, 스레드 컨텍스트 스위칭 비용은 스위칭할 때 스레드 간에 공유하는 자원을 제외한 스레드 정보(stack, register)만을 교체하면 되므로 프로세스 컨텍스트 스위칭 비용보다 상대적으로 낮은 것

### 단점

### 안전성 문제

멀티 프로세스 모델에서는 각 프로세스가 독립적으로 동작하므로 하나의 프로세스에서 문제가 발생해도 다른 프로세스들은 영향을 받지 않기 때문에 프로그램이 죽지 않고 계속 동작할 수 있다. 

![123](https://github.com/user-attachments/assets/08bacc8a-e5a7-47bb-b93e-4b2b679537cd)

**그러나 멀티 스레드 모델에서는 기본적으로 하나의 스레드에서 문제가 발생하면 다른 스레드들도 영향을 받아 전체 프로그램이 종료될 수 있다.**

### 동기화로 인한 성능 저하

멀티 스레드 모델은 여러 개의 스레드가 공유 자원에 동시에 접근할 수 있기 때문에, 동기화 문제가 발생할 수 있다.

- 예를들어 여러 스레드가 동시에 한 자원을 변경해 버린다면 의도되지 않은 엉뚱한 값을 읽어 서비스에 치명적인 버그가 생길수도 있다.
- 불필요 부분까지 동기화하면, 대기시간으로 인해 성능저하 발생한다.

### 데드락

Deadlock 이란, 다수의 프로세스나 스레드가 서로 자원을 점유하고, 다른 프로세스나 스레드가 점유한 자원을 기다리는 상황에서 발생하는 교착 상태를 말한다. 여러 개의 스레드가 서로 대기하면서 무한정 기다리게되는 무한 루프와 같은 증상이라고 보면된다.

![1234](https://github.com/user-attachments/assets/32f13cf6-24d1-4504-a6c8-5930d3771fa6)

이러한 현상은 스레드의 특징인 공유 자원에 대한 동시 엑세스로 인한 문제로, 이를 방지하기 위한 상호배제(Mutual Exclusion), 점유와 대기(Hold and Wait), 비선점(No Preemption), 순환 대기(Circular Wait) 등의 알고리즘을 통해 극복해야 한다.

다만, 데드락은 멀티 스레드만의 단점이라기 보다는 멀티 프로세스와 스레드 모델의 공통된 문제점이라고 말하는 것이 옳다. 왜냐하면 프로세스 끼리는 기본적으로 독립적인 메모리 공간이지만 IPC를 통해 공유 자원을 사용할 수 있기 때문에 멀티 스레드와 똑같이 교착 상태에 빠질 수 있기 때문이다.

### 디버깅이 어렵다.

멀티 스레드를 사용하면, 여러 개의 스레드가 동시에 실행되기 때문에, 각 스레드의 동작을 추적하기 어려울 수 있다. 

- 예를들어 코드를 디버깅하는 도중에 다른 스레드가 실행되어 예기치 않은 결과가 발생할 수 있다.
- 또한 어떤 스레드가 언제 어떤 자원에 접근하고, 어떤 순서로 실행되는지 등을 파악하기 어려울 수 있다.

### **Context Switching Overhead**

멀티 프로세스보다 멀티 스레드의 컨텍스트 스위칭 오버헤드가 작아 성능에 유리하지만 그래도 컨텍스트 스위칭 오버헤드 비용 자체가 없지 않다. 

- 따라서 스레드 수가 많다면 그만큼 컨텍스트 스위칭이 많이 발생되게 되고 당연히 이는 성능 저하로 이어진다.
